@import controllers.admin.AssessmentsController.AssessmentFormData
@import domain.{Assessment, StudentAssessment}
@import domain.tabula.SitsProfile
@import org.apache.commons.lang3.time.DurationFormatUtils
@import warwick.core.views.utils._
@import warwick.sso.UniversityID
@import views.html.b3.vertical.VerticalFieldConstructor

@(
  existing: Option[Assessment],
  students: Seq[StudentAssessment],
  studentInformation: Map[UniversityID, SitsProfile],
)(implicit context: RequestContext, messages: MessagesProvider, vfc: VerticalFieldConstructor, form: Form[AssessmentFormData])

<details class="panel panel-default" @if(form("students").hasErrors) { open } >
  <summary class="panel-heading">@students.size @pl(students.size, "student")()</summary>
  @if(existing.forall(_.tabulaAssessmentId.isEmpty)) {
    <div class="panel-body">
      @b3.textarea(form("students"), Symbol("_label") -> "Student IDs", Symbol("rows") -> 20, Symbol("_help") -> "Enter 7-digit student University IDs for this assessment, one per line.")
    </div>
  }
  <table class="table table-striped table-sortable">
    <thead>
      <tr>
        <th>University ID</th>
        <th>First name</th>
        <th>Last name</th>
        <th>Department</th>
        <th>User type</th>
        <th>Extra time (per hr)</th>
      </tr>
    </thead>
    <tbody>
      @students.map { student =>
        <tr>
          <td><a href="@context.tabulaConfiguration.getProfileUrl(student.studentId)" target="_blank">@student.studentId.string</a></td>
          @studentInformation.get(student.studentId) match {
            case Some(p) => {
              <td>@p.firstName</td>
              <td>@p.lastName</td>
              <td>@p.department.name</td>
              <td>@views.tags.profiles.typeAndAttendance(p)</td>
            }
            case _ => {
              <td colspan="4"><em>Unknown</em></td>
            }
          }
          <td data-sort="@student.extraTimeAdjustment.map(_.toMillis)">
            @student.extraTimeAdjustment.map(d => DurationFormatUtils.formatDurationWords(d.toMillis, true, true))
          </td>
        </tr>
      }
    </tbody>
  </table>
</details>
